name: Test Git Push Permissions

on:
  workflow_dispatch:
    inputs:
      use_pat:
        description: 'Use GHAPI_PAT token'
        required: false
        default: false
        type: boolean

jobs:
  test-permissions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout (with GITHUB_TOKEN)
        if: inputs.use_pat == false
        uses: actions/checkout@v4
      
      - name: Checkout (with PAT)
        if: inputs.use_pat == true
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GHAPI_PAT }}
      
      - name: Check push permissions via GitHub API
        env:
          CHECK_TOKEN: ${{ inputs.use_pat == true && secrets.GHAPI_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking repository permissions via GitHub API..."
          
          # First, verify the token works at all
          echo "Testing token authentication..."
          AUTH_RESPONSE=$(curl -s -H "Authorization: token $CHECK_TOKEN" \
            https://api.github.com/user)
          
          if echo "$AUTH_RESPONSE" | jq -e '.login' > /dev/null; then
            echo "✅ Token is valid, authenticated as: $(echo "$AUTH_RESPONSE" | jq -r '.login')"
          else
            echo "❌ Token authentication failed"
            echo "$AUTH_RESPONSE" | jq '.'
            exit 1
          fi
          
          # Now check repo permissions
          echo ""
          echo "Checking permissions for malloydata/malloy-cli..."
          RESPONSE=$(curl -s -H "Authorization: token $CHECK_TOKEN" \
            https://api.github.com/repos/malloydata/malloy-cli)
          
          # Check if we got an error
          if echo "$RESPONSE" | jq -e '.message' > /dev/null; then
            echo "❌ API Error: $(echo "$RESPONSE" | jq -r '.message')"
            echo "This token may not have access to this repository"
            exit 1
          fi
          
          PUSH_PERMISSION=$(echo "$RESPONSE" | jq -r '.permissions.push // false')
          
          echo "Push permission: $PUSH_PERMISSION"
          
          if [ "$PUSH_PERMISSION" = "true" ]; then
            echo "✅ SUCCESS: Push permissions verified via API!"
            echo "This setup CAN push to the repository."
          else
            echo "❌ FAILED: No push permissions!"
            echo "This setup CANNOT push to the repository."
            echo "Full permissions:"
            echo "$RESPONSE" | jq '.permissions'
            exit 1
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## 🔐 Git Permission Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Auth Method**: ${{ inputs.use_pat && 'GHAPI_PAT Token' || 'GITHUB_TOKEN' }}" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "- **Result**: ✅ Push permissions verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Result**: ❌ No push permissions" >> $GITHUB_STEP_SUMMARY
          fi
