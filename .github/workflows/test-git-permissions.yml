name: Test Git Push Permissions

on:
  workflow_dispatch:
    inputs:
      use_pat:
        description: 'Use GitHub App token'
        required: false
        default: false
        type: boolean

jobs:
  test-permissions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate token from GitHub App
        if: inputs.use_pat == true
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.NPM_ACTIONS_APP_ID }}
          private-key: ${{ secrets.NPM_ACTIONS_PRIVATE_KEY }}
      
      - name: Checkout (with GITHUB_TOKEN)
        if: inputs.use_pat == false
        uses: actions/checkout@v4
      
      - name: Checkout (with GitHub App token)
        if: inputs.use_pat == true
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
      
      - name: Check push permissions via GitHub API
        env:
          CHECK_TOKEN: ${{ inputs.use_pat == true && steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking repository permissions via GitHub API..."
          
          # Check repo permissions directly (skip user check for GitHub Apps)
          echo "Checking permissions for malloydata/malloy-cli..."
          RESPONSE=$(curl -s -H "Authorization: token $CHECK_TOKEN" \
            https://api.github.com/repos/malloydata/malloy-cli)
          
          # Check if we got an error
          if echo "$RESPONSE" | jq -e '.message' > /dev/null; then
            echo "âŒ API Error: $(echo "$RESPONSE" | jq -r '.message')"
            echo "This token may not have access to this repository"
            echo "Full response:"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi
          
          PUSH_PERMISSION=$(echo "$RESPONSE" | jq -r '.permissions.push // false')
          
          echo "Push permission: $PUSH_PERMISSION"
          
          if [ "$PUSH_PERMISSION" = "true" ]; then
            echo "âœ… SUCCESS: Push permissions verified via API!"
            echo "This setup CAN push to the repository."
          else
            echo "âŒ FAILED: No push permissions!"
            echo "This setup CANNOT push to the repository."
            echo "Full permissions:"
            echo "$RESPONSE" | jq '.permissions'
            exit 1
          fi
          
          # Write success to summary
          echo "## ðŸ” Git Permission Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Auth Method**: ${{ inputs.use_pat && 'GitHub App Token' || 'GITHUB_TOKEN' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Result**: âœ… Push permissions verified" >> $GITHUB_STEP_SUMMARY
      
      - name: Failure Summary
        if: failure()
        run: |
          echo "## ðŸ” Git Permission Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Auth Method**: ${{ inputs.use_pat && 'GitHub App Token' || 'GITHUB_TOKEN' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Result**: âŒ Permission check failed" >> $GITHUB_STEP_SUMMARY
